{% extends "admin/base.html" %}

{% block title %}Help & Credits{% endblock %}
{% block header_title %}Help & Credits{% endblock %}

{% block content %}
<style>
    .toc-link {
        display: block;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        transition: all 0.2s ease-in-out;
        border-left: 3px solid transparent;
    }
    .toc-link:hover {
        background-color: rgba(128, 128, 128, 0.1);
        padding-left: 1.25rem;
    }
    .toc-link.active-toc {
        color: var(--color-primary-500);
        font-weight: 600;
        border-left-color: var(--color-primary-500);
    }
    .ui-brutalism .toc-link.active-toc {
        background-color: var(--color-primary-500);
        color: white;
        border: 3px solid black;
    }
</style>

<div class="flex flex-col lg:flex-row gap-12">

    <!-- Main Content -->
    <div class="w-full lg:w-3/4 space-y-12">

        <!-- Getting Started Workflow -->
        <div id="getting-started" class="card-style scroll-mt-20">
            <h2 class="card-header text-2xl font-bold mb-6 pb-2">üöÄ Getting Started: Your Workflow</h2>
            <div class="space-y-4 text-current">
                <ol class="list-decimal list-inside space-y-4">
                    <li>
                        <strong>Configure Servers:</strong> Go to <a href="{{ url_for('admin_servers') }}" class="font-semibold text-[var(--color-primary-600)] hover:underline">Server Management</a> and add the URLs of your Ollama instances.
                    </li>
                    <li>
                        <strong>Create a User:</strong> Navigate to <a href="{{ url_for('admin_users') }}" class="font-semibold text-[var(--color-primary-600)] hover:underline">User Management</a> to create accounts for your users or applications.
                    </li>
                    <li>
                        <strong>Generate an API Key:</strong> Click "Manage Keys" for a user. On their details page, generate a new key, giving it a descriptive name and optional rate limits.
                    </li>
                    <li>
                        <strong>Copy the Key:</strong> The full API key is shown **only once**. Copy it immediately and store it securely in your application's configuration.
                    </li>
                    <li>
                        <strong>Use the Key:</strong> In your applications, point to the proxy's URL (e.g., `http://127.0.0.1:8080`) and provide the API key in the `Authorization` header as a `Bearer` token.
                    </li>
                </ol>
            </div>
        </div>

        <!-- Core Concepts Section -->
        <div id="concepts" class="card-style scroll-mt-20">
            <h2 class="card-header text-2xl font-bold mb-6 pb-2">üí° Core Concepts</h2>
            <div class="space-y-6 text-current">
                <div>
                    <h4 class="font-semibold text-lg">‚öñÔ∏è Load Balancing & High Availability</h4>
                    <p>The proxy distributes requests across your backend servers in a round-robin fashion. This prevents any single server from being overwhelmed and means your service remains available even if one of your Ollama instances goes down.</p>
                </div>
                <div>
                    <h4 class="font-semibold text-lg">üß† Smart Model Routing</h4>
                    <p>When you request a model like <code class="inline-code">"llama3"</code>, the proxy intelligently routes the request only to servers that have that model available. This prevents failed requests and saves compute resources.</p>
                    <div class="mt-3 p-3 rounded-md text-sm info-box">
                        <strong>Pro-Tip:</strong> For Smart Routing to work best, enable the periodic model refresh in <a href="{{ url_for('admin_settings') }}" class="font-semibold underline">Settings</a> or manually click <strong>"Refresh Models"</strong> on the Server Management page.
                    </div>
                </div>
                <div>
                    <h4 class="font-semibold text-lg">üåê Federated Model Listing</h4>
                    <p>The standard <code class="inline-code">/api/tags</code> endpoint is supercharged. Calling it through the proxy returns a single, de-duplicated list of all unique models available across your *entire* fleet of servers, giving you a unified view.</p>
                </div>
                 <div>
                    <h4 class="font-semibold text-lg">üîÑ Automatic Retries</h4>
                    <p>If a request to a backend server fails due to a temporary network issue or a 5xx error, the proxy won't give up immediately. It will automatically retry the request with an intelligent backoff strategy, increasing the resilience of your AI services.</p>
                </div>
            </div>
        </div>

        <!-- HTTPS/SSL Setup -->
        <div id="https-setup" class="card-style scroll-mt-20">
            <h2 class="card-header text-2xl font-bold mb-6 pb-2">üîí Encrypting Traffic with HTTPS/SSL</h2>
            <div class="space-y-6 text-current">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Why is this important?</h3>
                    <p>By default, traffic to the proxy is unencrypted (HTTP). This is fine for local testing, but if the proxy is accessible on a network, your prompts and model responses could be intercepted. HTTPS encrypts this traffic, making it secure.</p>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Configuration Methods</h3>
                    <p>In the <a href="{{ url_for('admin_settings') }}" class="font-semibold text-[var(--color-primary-600)] hover:underline">Settings</a> page, you have two simple ways to enable SSL:</p>
                    <ul class="list-disc list-inside space-y-3 mt-3 pl-4">
                        <li>
                            <strong>Uploading Files (Easiest):</strong> Simply use the "Upload Key File" and "Upload Certificate File" buttons. The files will be securely stored on the server and automatically configured for use.
                        </li>
                        <li>
                            <strong>Using File Paths:</strong> If your SSL certificates are already on the server (e.g., managed by Certbot), you can provide the absolute paths to the key and certificate files.
                        </li>
                    </ul>
                     <div class="mt-4 p-3 rounded-md text-sm warning-box">
                        <strong>Action Required:</strong> Changes to SSL settings require a **full server restart** to take effect.
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Need Certificates for Testing?</h3>
                    <p>You can generate a self-signed certificate valid for 365 days with a single command (requires OpenSSL). This is perfect for local development.</p>
                     <div class="code-block-wrapper mt-2">
                        <pre><code class="language-bash">openssl req -x509 -newkey rsa:4096 -keyout key.pem -out cert.pem -sha256 -days 365 -nodes -subj "/CN=localhost"</code></pre>
                        <button class="copy-button">Copy</button>
                    </div>
                </div>
            </div>
        </div>
            
        <!-- Usage Examples Section -->
        <div id="examples" class="card-style scroll-mt-20">
            <h2 class="card-header text-2xl font-bold mb-6 pb-2">üë®‚Äçüíª Usage Examples</h2>
            <div class="space-y-8">
                <div>
                    <h3 class="text-xl font-semibold mb-2">cURL</h3>
                    <div class="code-block-wrapper">
                        <pre><code class="language-bash">
curl http://127.0.0.1:8080/api/generate \
  -H "Authorization: Bearer op_prefix_secret" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "llama3",
    "prompt": "Why is the sky blue?",
    "stream": false
  }'</code></pre>
                        <button class="copy-button">Copy</button>
                    </div>
                </div>
                <div>
                    <h3 class="text-xl font-semibold mb-2">Python (`requests`)</h3>
                    <div class="code-block-wrapper">
                        <pre><code class="language-python">
import requests
import json

proxy_url = "http://127.0.0.1:8080/api/chat"
api_key = "op_prefix_secret"

headers = {
    "Authorization": f"Bearer {api_key}",
    "Content-Type": "application/json"
}

data = {
    "model": "llama3",
    "messages": [
        {"role": "user", "content": "Explain quantum computing simply."}
    ],
    "stream": False
}

try:
    response = requests.post(proxy_url, headers=headers, data=json.dumps(data))
    response.raise_for_status() # Raises an exception for bad status codes
    print(response.json())
except requests.exceptions.RequestException as e:
    print(f"An error occurred: {e}")
</code></pre>
                        <button class="copy-button">Copy</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Redis Setup Guide -->
        <div id="redis-setup" class="card-style scroll-mt-20">
            <h2 class="card-header text-2xl font-bold mb-6 pb-2">‚ö° Redis Setup Guide</h2>
            <div class="space-y-6 text-current">
                <div>
                    <h3 class="text-xl font-semibold mb-2">Why Do I Need Redis?</h3>
                    <p>Redis is an optional but highly recommended in-memory database used for two critical security features:</p>
                    <ul class="list-disc list-inside space-y-2 mt-2 pl-4">
                        <li><strong>API Rate Limiting:</strong> Prevents abuse by limiting how many requests a key can make in a given time.</li>
                        <li><strong>Brute-Force Protection:</strong> Temporarily locks an IP address after too many failed admin login attempts.</li>
                    </ul>
                </div>
                 <div>
                    <h3 class="text-xl font-semibold mb-2">Installation (Docker is Easiest)</h3>
                    <p>The fastest way to run Redis is with Docker. This command will start a Redis instance that restarts automatically.</p>
                    <div class="code-block-wrapper mt-2">
                        <pre><code class="language-bash">docker run -d --name redis-stack -p 6379:6379 --restart always redis/redis-stack:latest</code></pre>
                         <button class="copy-button">Copy</button>
                    </div>
                </div>
                 <div>
                    <h3 class="text-xl font-semibold mb-2">Configuration</h3>
                    <p>Once Redis is running, go to the <a href="{{ url_for('admin_settings') }}" class="font-semibold text-[var(--color-primary-600)] hover:underline">Settings</a> page, enter your connection details (the defaults are usually correct for a local install), and save. The proxy will connect automatically.</p>
                </div>
            </div>
        </div>
        
        <!-- Credits Section -->
        <div id="credits" class="card-style scroll-mt-20">
            <h2 class="card-header text-2xl font-bold mb-6 pb-2">üíñ Credits & Acknowledgements</h2>
            <div class="space-y-4 text-current">
                <p>This application was developed with passion by the open-source community. It stands on the shoulders of giants:</p>
                <ul class="list-disc list-inside space-y-2 pl-4">
                    <li><strong>Core Technologies:</strong> FastAPI, SQLAlchemy, Jinja2, Chart.js, and Tailwind CSS.</li>
                     <li><strong>Project Lead:</strong> ParisNeo</li>
                </ul>
                <p class="pt-4">Visit the project on <a href="https://github.com/ParisNeo/ollama_proxy_server" target="_blank" class="font-semibold text-[var(--color-primary-600)] hover:underline">GitHub</a> to contribute, report issues, or star the repository!</p>
            </div>
        </div>
    </div>

    <!-- Sticky Table of Contents -->
    <div class="w-full lg:w-1/4">
        <div class="sticky top-10">
            <div class="card-style">
                <h3 class="card-header text-lg font-bold mb-4">On this page</h3>
                <nav>
                    <ul class="space-y-2">
                        <li><a href="#getting-started" class="toc-link">Getting Started</a></li>
                        <li><a href="#concepts" class="toc-link">Core Concepts</a></li>
                        <li><a href="#https-setup" class="toc-link">HTTPS/SSL Setup</a></li>
                        <li><a href="#examples" class="toc-link">Usage Examples</a></li>
                        <li><a href="#redis-setup" class="toc-link">Redis Setup</a></li>
                        <li><a href="#credits" class="toc-link">Credits</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Copy button logic
    document.querySelectorAll('.copy-button').forEach(button => {
        button.addEventListener('click', () => {
            const codeBlock = button.previousElementSibling.querySelector('code');
            const text = codeBlock.innerText;
            
            navigator.clipboard.writeText(text).then(() => {
                const originalText = button.textContent;
                button.textContent = 'Copied!';
                setTimeout(() => {
                    button.textContent = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy text: ', err);
            });
        });
    });

    // Table of Contents scroll-spy logic
    const sections = document.querySelectorAll('div[id]');
    const tocLinks = document.querySelectorAll('.toc-link');

    const observer = new IntersectionObserver((entries) => {
        let visibleSectionId = null;
        entries.forEach(entry => {
            if (entry.isIntersecting && (!visibleSectionId || entry.intersectionRatio > 0.5)) {
                visibleSectionId = entry.target.getAttribute('id');
            }
        });

        if (visibleSectionId) {
             tocLinks.forEach(link => {
                link.classList.remove('active-toc');
                if (link.getAttribute('href') === `#${visibleSectionId}`) {
                    link.classList.add('active-toc');
                }
            });
        }
    }, {
        rootMargin: '-20% 0px -70% 0px',
        threshold: [0, 0.5, 1]
    });

    sections.forEach(section => {
        observer.observe(section);
    });
});
</script>
{% endblock %}